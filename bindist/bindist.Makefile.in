#---------------------------------------------------------------------------#
# Copyright (C) 1996-1999, 2001 The University of Melbourne.
# This file may only be copied under the terms of the GNU General
# Public License - see the file COPYING in the Mercury distribution.
#---------------------------------------------------------------------------#
#
# @configure_input@
#

SHELL=		/bin/sh

INSTALL_PREFIX	= @PREFIX@
INSTALL_BINDIR	= $(INSTALL_PREFIX)/bin
INSTALL_LIBDIR	= $(INSTALL_PREFIX)/lib/mercury
INSTALL_INFODIR = $(INSTALL_PREFIX)/info
INSTALL_MAN_DIR = $(INSTALL_PREFIX)/man
INSTALL_ELISP_DIR = $(INSTALL_PREFIX)/lib/mercury/elisp
INSTALL_CGI_DIR = @CGIDIR@

# These scripts are generated by configure from the corresponding `.in' file
INSTALL_SCRIPTS		= scripts/c2init scripts/mmc \
			scripts/mercury_update_interface scripts/mgnuc \
			scripts/ml scripts/mmake scripts/mprof \
			scripts/mdb scripts/mkfifo_using_mknod

INSTALL_CGI_SCRIPTS	= scripts/mdprof

INSTALL_EMACS_SCRIPTS	= scripts/gud.el

INSTALL_MMAKE_EXTRAS	= scripts/Mmake.rules scripts/Mmake.vars

INSTALL_MDB_EXTRAS	= scripts/mdbrc

LIB_PARTS		= bin doc html inc ints lib mdb/mdb_doc modules

EXT_FOR_EXE		= @EXT_FOR_EXE@

FULLARCH		= @FULLARCH@

GACUTIL			= @GACUTIL@

UTIL_PROGS		= util/mkinit util/mdemangle
UTIL_PROGFILENAMES	= $(UTIL_PROGS:%=%$(EXT_FOR_EXE))

# Any miscellaneous scripts and utilities not processed by configure
UTILS			= $(UTIL_PROGFILENAMES) util/mtags \
			  util/mprof_merge_runs util/vpath_find \
			  util/mercury_cleanup_install

ENABLE_DEEP_PROFILER    = @ENABLE_DEEP_PROFILER@

#-----------------------------------------------------------------------------#

all:
	# since this is a binary distribution, we don't need to
	# make anything
	@echo "-- The binary distribution does not need building."
	@echo "-- Use \`make install' to install"

.PHONY: install
install: install_lib install_info install_man \
		install_scripts install_emacs_scripts install_cgi_scripts \
		install_mmake install_mdb install_util install_gac
	@echo
	@echo "-- Don't forget to add $(INSTALL_BINDIR) to your PATH,"
	@echo "-- $(INSTALL_MAN_DIR) to your MANPATH,"
	@echo "-- and $(INSTALL_INFODIR) to your INFOPATH,"
	@if test $(ENABLE_DEEP_PROFILER) != yes || \
		cmp -s scripts/mdprof.in $(INSTALL_CGI_DIR)/mdprof; \
	then true ; else \
		echo "-- to copy scripts/mdprof to $(INSTALL_CGI_DIR),"; \
	fi
	@echo "-- and to add the following lines to the \`.emacs' file"
	@echo "-- in your home directory:"
	@echo "	(setq load-path (cons (expand-file-name "
	@echo "		\"$(INSTALL_ELISP_DIR)\") load-path))"
	@echo "	(autoload 'mdb \"gud\" \"Invoke the Mercury debugger\" t)"

.PHONY: install_lib
install_lib:
	@echo "-- Installing lib in $(INSTALL_LIBDIR)..."
	test -d $(INSTALL_LIBDIR) || mkdir -p $(INSTALL_LIBDIR)
	gzip --decompress --stdout lib.tar.gz | ( \
		cd $(INSTALL_LIBDIR) && tar -xf - $(LIB_PARTS) )
	@echo "-- Done."

.PHONY: install_info
install_info:
	@echo "-- Installing info documentation in $(INSTALL_INFODIR)..."
	test -d $(INSTALL_INFODIR) || mkdir -p $(INSTALL_INFODIR)
	gzip --decompress --stdout info.tar.gz | ( \
		cd $(INSTALL_INFODIR)/.. && tar -xf - )
	@echo "-- Done."

.PHONY: install_man
install_man:
	@echo "-- Installing man pages in $(INSTALL_MAN_DIR)..."
	test -d $(INSTALL_MAN_DIR) || mkdir -p $(INSTALL_MAN_DIR)
	# (XXX don't use redirection or pipes, because on gnu-win32
	# stdout defaults to text mode, which breaks tar and gzip)
	gzip --decompress --stdout man.tar.gz | ( \
		cd $(INSTALL_MAN_DIR)/.. && tar -xf - )
	@echo "-- Done."

.PHONY: install_scripts
install_scripts:
	@echo "-- Installing scripts in $(INSTALL_BINDIR)"
	test -d $(INSTALL_BINDIR) || mkdir -p $(INSTALL_BINDIR)
	cp $(INSTALL_SCRIPTS) $(INSTALL_BINDIR)
	for file in $(INSTALL_SCRIPTS); do \
		base=`basename $$file`; \
		chmod u+w $(INSTALL_BINDIR)/$$base ;\
	done
	@echo "-- Done."

install_emacs_scripts:
	@echo "-- Installing Emacs lisp scripts in $(INSTALL_ELISP_DIR)"
	test -d $(INSTALL_ELISP_DIR) || mkdir -p $(INSTALL_ELISP_DIR)
	cp $(INSTALL_EMACS_SCRIPTS) $(INSTALL_ELISP_DIR)

.PHONY: install_cgi_scripts
install_cgi_scripts: $(INSTALL_CGI_SCRIPTS)
	# $(INSTALL_CGI_DIR) is likely to be writeable only by root or
	# the www system administrator, which is why we don't consider a
	# failure of this action to be an error. If the command fails,
	# the action for the `install' target will remind the user
	# to do the copy later.
	-if test $(ENABLE_DEEP_PROFILER) = yes ; then \
		cp $(INSTALL_CGI_SCRIPTS) $(INSTALL_CGI_DIR) ; \
	fi

.PHONY: install_mmake
install_mmake: 
	test -d $(INSTALL_LIBDIR)/mmake || mkdir -p $(INSTALL_LIBDIR)/mmake
	cp $(INSTALL_MMAKE_EXTRAS) $(INSTALL_LIBDIR)/mmake

.PHONY: install_mdb
install_mdb: 
	test -d $(INSTALL_LIBDIR)/mdb || mkdir -p $(INSTALL_LIBDIR)/mdb
	cp $(INSTALL_MDB_EXTRAS) $(INSTALL_LIBDIR)/mdb

.PHONY: install_util
install_util: 
	test -d $(INSTALL_BINDIR) || mkdir -p $(INSTALL_BINDIR)
	cp $(UTILS) $(INSTALL_BINDIR)

ifneq ("$(strip $(GACUTIL))","")
.PHONY: install_gac
install_gac: 
	if test -d $(INSTALL_LIBDIR)/lib/ilc/ ; then 		\
		cd $(INSTALL_LIBDIR)/lib/ilc/$(FULLARCH) &&	\
		$(GACUTIL) -i mercury.dll ; 			\
	fi
else
.PHONY: install_gac
install_gac: 
endif

#-----------------------------------------------------------------------------#

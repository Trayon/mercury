#-----------------------------------------------------------------------------#

main_target: check

include ../Mmake.common
-include ../Mmake.params

#-----------------------------------------------------------------------------#

SIMPLE_PROGS = \
	boyer \
	expand \
	expand_float \
	expand_poly \
	expand_tuple \
	fib \
	fib_float \
	fib_list \
	fib_string \
	loopcheck \
	unused_args

NONDET_PROGS = \
	coup \
	coup_det_frame \
	coup_no_commit \
	coup_non_tabled_frame \
	generator_in_commit \
	repeat \
	seq \
	tc_loop \
	tc_minimal

# We don't yet pass the following minimal model tests. The reason is that
# they contain interactions between tabling and constructs that function
# as negated contexts.
#
#	consumer_in_commit
#	consumer_in_solutions

# Tabling does not yet work in .rt grades
ifneq "$(findstring .gc,$(GRADE))" ""
	ifneq "$(findstring .rt,$(GRADE))" ""
		PROGS=
	else
		ifneq "$(findstring .mm,$(GRADE))" ""
			PROGS=$(SIMPLE_PROGS) $(NONDET_PROGS)
		else
			PROGS=$(SIMPLE_PROGS)
		endif
	endif
else
	PROGS=
endif

#-----------------------------------------------------------------------------#

# With the Mercury system as of 17 September 1998,
# tc_minimal works on some machines even in the presence of a known bug
# if inlining is turned on, so we turn inlining off to make the test tougher.
MCFLAGS-tc_minimal	=	--no-inlining

# Some test cases are expected to abort.
# We also need to pipe the output for these test cases through sed to avoid
# hard-coding dependencies on particular line numbers in the standard library
# source code.

tc_loop.out: tc_loop
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

loopcheck.out: loopcheck
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

#-----------------------------------------------------------------------------#

DEPS=	$(PROGS:%=%.dep)
DEPENDS=$(PROGS:%=%.depend)
OUTS=	$(PROGS:%=%.out)
RESS=	$(PROGS:%=%.res)

#-----------------------------------------------------------------------------#

MMAKEFLAGS =

dep:	$(DEPS)

depend:	$(DEPENDS)

check:	$(OUTS) $(RESS)

all:	$(PROGS)

clean_local:

realclean_local:

#-----------------------------------------------------------------------------#

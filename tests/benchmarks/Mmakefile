#-----------------------------------------------------------------------------#

main_target: check

include ../Mmake.common
-include ../Mmake.params

#-----------------------------------------------------------------------------#

# uncomment the following line to test the performance
# of the benchmarks (with I/O suppressed)
# MLFLAGS=-w "`extract $(*:_init=) '' BenchEntry`"

MCFLAGS += --mode-constraints -V -dpolymorphism -dmode_constraints --dump-hlds-options C -D ALL

#-----------------------------------------------------------------------------#

ifeq ($(HAVE_NUPROLOG),yes)
%.exp: %.nu
	{ [ -f $*.inp ] && cat $*.inp; } | ./$< > $@ 2>&1;
endif

#-----------------------------------------------------------------------------#

PROGS=	\
	cqueens \
	crypt \
	deriv \
	deriv2 \
	nrev \
	poly \
	primes \
	qsort \
	queens \
	query \
	tak

DEPENDS=$(PROGS:%=%.depend)
DEPS=	$(PROGS:%=%.dep)
OUTS=	$(PROGS:%=%.out)
EXPS=	$(PROGS:%=%.exp)
RESS=	$(PROGS:%=%.res)
SS=	$(PROGS:%=%.s)
CS=	$(PROGS:%=%.c)
TIMES=	$(PROGS:%=%.time)

dep:	$(DEPS)

depend:	$(DEPENDS)

exp:	$(EXPS)

check:	$(OUTS) $(RESS)

outs:	$(OUTS)

cs:	$(CS)

ss:	$(SS)

all:	$(PROGS)

times:	$(TIMES)

dir.%:	$(PROGS) $(SS)
	-mkdir $@
	cp $(PROGS) $(SS) $@
	cp BenchEntry $@

clean_exes:	
	rm -f $(PROGS)

%.time: %
	{ count=`awk '/$*/ { print $$2; exit; }' < BenchRepeatCounts`; \
	echo "$$count	"; \
	MERCURY_OPTIONS="-t -r$$count" ./repeat_time 3 ./$*; } 2>&1 | tee $@

#-----------------------------------------------------------------------------#

#!/bin/sh
# Test whether the code generated by the Mercury compiler is producing 
# the same output as code generated by the NU-Prolog compiler.
# Return a status of 0 (true) if everything is all right, and 1 otherwise.
#
# The .exp files containing the expected output of each test should be under
# CVS control. They can be updated by running
#
#	mmake realclean
#	mmake depend
#	mmake exp
#
# on a machine that has NU-Prolog installed.

. ../../handle_options
. ../../startup

eval mmake $mmakeopts depend || exit 1
eval mmake $mmakeopts -k check
checkstatus=$?

cat *.res > .allres
if test ! -s .allres -a "$checkstatus" = 0
then
    grep -h "% mode.*AccFrom" *hlds*acc* | \
   	 sed -e 's/number//' -e 's/ of predicate//' -e 's/ of function//' \
	 -e 's,__[0-9]*__[0-9]*/,/,' > I.$$
    diff -u INTRODUCED I.$$ > INTRODUCED.diff
    rm -f I.$$

    if [ -s INTRODUCED.diff ]; then
        echo "** the tests in the general/accumulator directory failed"
        echo "** as some predicates didn't have accumulators introduced"
        echo "mmakeopts=$mmakeopts"
	    echo "the predicates are:"
        cat INTRODUCED.diff
        exit 1
    fi

	echo "the tests in the general/accumulator directory succeeded"
	echo "mmakeopts=$mmakeopts"
	rm -f .allres INTRODUCED.diff
	. ../../shutdown
	exit 0
else
	echo "** the tests in the general/accumulator directory failed"
	echo "** as some test cases didn't produce the correct output"
	echo "mmakeopts=$mmakeopts"
	echo "the differences are:"
	cat .allres
	exit 1
fi

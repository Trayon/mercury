#-----------------------------------------------------------------------------#

main_target:	check

include ../Mmake.common
-include ../Mmake.params

#-----------------------------------------------------------------------------#

# We suppress the printing of the banner, because different workspaces
# may get different version numbers printed in it. This would otherwise be
# the source of irrelevant difference between the actual and expected outputs.

MDB = MERCURY_SUPPRESS_MDB_BANNER=yes mdb

#-----------------------------------------------------------------------------#

RETRY_PROGS = \
	all_solutions			\
	browser_test			\
	mdb_command_test		\
	queens				\
	retry				\
	tabled_read			\
	tabled_read_decl

NONRETRY_PROGS = \
	breakpoints			\
	browse_pretty			\
	cmd_quote			\
	completion			\
	debugger_regs			\
	exception_cmd			\
	exception_value			\
	exception_vars			\
	existential_type_classes	\
	field_names			\
	higher_order			\
	implied_instance		\
	interpreter			\
	loopcheck			\
	lval_desc_array			\
	multi_parameter			\
	nondet_stack			\
	output_term_dep			\
	polymorphic_output		\
	print_goal			\
	queens_rep			\
	resume_typeinfos		\
	shallow				\
	type_desc_test

# The completion test requires mdb to use readline, even though
# the input is not a terminal.
MLFLAGS-completion = --runtime-flags --force-readline

MCFLAGS-queens_rep = --trace rep
MCFLAGS-shallow = --trace shallow
MCFLAGS-tabled_read = --trace-table-io
MCFLAGS-tabled_read_decl = --trace-table-io-decl
# By default, we reclaim heap on failure in non-Boehm-gc grades.
# The extra stack slots required for this reclamation cause spurious
# differences from the expected output on the nondet_stack test case.
# The optimization level also affects stack frame sizes.
MCFLAGS-nondet_stack = -O2 --no-reclaim-heap-on-failure

MCFLAGS += --trace deep
MLFLAGS += --trace

# We need to use shared libraries for interactive queries to work.
# The following is necessary for shared libraries to work on Linux.
GRADEFLAGS-interactive = --pic-reg
MLFLAGS-interactive = --shared

# Since the `interactive' test case requires the use of shared libraries,
# this means it won't work properly if the static libraries are linked
# (as is done by tools/bootcheck and tools/lmc).
# So we only enable it if LINK_STATIC is not set.
ifeq ($(origin LINK_STATIC),undefined)
LINK_STATIC = no
endif
ifeq ($(LINK_STATIC),no)
	RETRY_PROGS := $(RETRY_PROGS) interactive
endif

# Debugging doesn't yet don't work in MLDS grades (hl*), and the retry command
# doesn't and will not work in deep profiling grades (profdeep).
# Also base grades `jump' and `fast' cannot be used with
# stack layouts (which are required for tracing).

ifneq "$(findstring hl,$(GRADE))" ""
    PROGS=
else
    ifneq "$(findstring profdeep,$(GRADE))" ""
	# Eventually, this should be DEBUGGER_PROGS=$(NONRETRY_PROGS).
	# However, the code that is required to switch off the profiling
	# primitives in Mercury code invoked by the debugger (e.g. for
	# browsing) has not yet been implemented.
    	DEBUGGER_PROGS=
    else
    	DEBUGGER_PROGS=$(NONRETRY_PROGS) $(RETRY_PROGS)
    endif
    ifneq "$(findstring asm_,$(GRADE))" ""
        PROGS=$(DEBUGGER_PROGS)
    else
        ifneq "$(findstring jump,$(GRADE))" ""
            PROGS=
        else
            ifneq "$(findstring fast,$(GRADE))" ""
                PROGS=
            else
                PROGS=$(DEBUGGER_PROGS)
            endif
        endif
    endif
endif

#-----------------------------------------------------------------------------#

all_solutions.out: all_solutions all_solutions.inp
	$(MDB) ./all_solutions < all_solutions.inp > all_solutions.out 2>&1

breakpoints.out: breakpoints breakpoints.inp
	$(MDB) ./breakpoints < breakpoints.inp > breakpoints.out 2>&1

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
browse_pretty.out: browse_pretty browse_pretty.inp
	$(MDB) ./browse_pretty < browse_pretty.inp 2>&1 | \
		sed 's/io.m:[0-9]*/io.m:NNNN/g' > browse_pretty.out 2>&1

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
browser_test.out: browser_test browser_test.inp
	$(MDB) ./browser_test < browser_test.inp 2>&1 | \
		sed 's/io.m:[0-9]*/io.m:NNNN/g' > browser_test.out 2>&1

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
cmd_quote.out: cmd_quote cmd_quote.inp
	$(MDB) ./cmd_quote < cmd_quote.inp 2>&1 | \
		sed 's/io.m:[0-9]*/io.m:NNNN/g' > cmd_quote.out 2>&1

# Set up readline to make it easier to use completion non-interactively.
completion.out: completion completion.inp
	INPUTRC=completion.inputrc $(MDB) ./completion \
		< completion.inp 2>&1 | sed -e '/^$$/d' > completion.out 2>&1

debugger_regs.out: debugger_regs debugger_regs.inp
	$(MDB) ./debugger_regs < debugger_regs.inp > debugger_regs.out 2>&1

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
exception_value.out: exception_value exception_value.inp
	$(MDB) ./exception_value < exception_value.inp 2>&1 | \
		sed -e 's/exception.m:[0-9]*/exception.m:NNNN/g' | \
		sed -e '/EXCP/s/).*/)/' > exception_value.out 2>&1

# The exception_cmd, exception_vars, polymorphic_output and loopcheck tests
# are supposed to return a non-zero exit status, since they exit by throwing
# an exception. We strip the goal paths from their exception events, since
# the exact goal paths are dependent on optimization level. The stripping
# must be done outside the condition of the if-then-else.
exception_cmd.out: exception_cmd exception_cmd.inp
	if $(MDB) ./exception_cmd < exception_cmd.inp		\
		> exception_cmd.tmp 2>&1;			\
	then							\
		sed -e '/EXCP/s/).*/)/' < exception_cmd.tmp	\
			> exception_cmd.out 2>&1;		\
		rm exception_cmd.tmp;				\
		false;						\
	else							\
		sed -e '/EXCP/s/).*/)/' < exception_cmd.tmp	\
			> exception_cmd.out 2>&1;		\
		rm exception_cmd.tmp;				\
		true;						\
	fi

exception_vars.out: exception_vars exception_vars.inp
	if $(MDB) ./exception_vars < exception_vars.inp		\
		> exception_vars.tmp 2>&1;			\
	then							\
		sed -e '/EXCP/s/).*/)/' < exception_vars.tmp	\
			> exception_vars.out 2>&1;		\
		rm exception_vars.tmp;				\
		false;						\
	else							\
		sed -e '/EXCP/s/).*/)/' < exception_vars.tmp	\
			> exception_vars.out 2>&1;		\
		rm exception_vars.tmp;				\
		true;						\
	fi

polymorphic_output.out: polymorphic_output polymorphic_output.inp
	if $(MDB) ./polymorphic_output < polymorphic_output.inp	\
		> polymorphic_output.tmp 2>&1;			\
	then							\
		sed -e '/EXCP/s/).*/)/' < polymorphic_output.tmp\
			> polymorphic_output.out 2>&1;		\
		rm polymorphic_output.tmp;			\
		false;						\
	else							\
		sed -e '/EXCP/s/).*/)/' < polymorphic_output.tmp\
			> polymorphic_output.out 2>&1;		\
		rm polymorphic_output.tmp;			\
		true;						\
	fi

loopcheck.out: loopcheck loopcheck.inp
	if $(MDB) ./loopcheck < loopcheck.inp			\
		> loopcheck.tmp 2>&1;				\
	then							\
		sed -e '/EXCP/s/).*/)/'				\
		    -e 's/require.m:[0-9]*/require.m:NNNN/g'	\
			< loopcheck.tmp > loopcheck.out 2>&1;	\
		rm loopcheck.tmp;				\
		false;						\
	else							\
		sed -e '/EXCP/s/).*/)/'				\
		    -e 's/require.m:[0-9]*/require.m:NNNN/g'	\
			< loopcheck.tmp	> loopcheck.out 2>&1;	\
		rm loopcheck.tmp;				\
		true;						\
	fi

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
existential_type_classes.out: existential_type_classes \
			existential_type_classes.inp
	$(MDB) ./existential_type_classes < existential_type_classes.inp 2>&1 | \
		sed 's/string.m:[0-9]*/string.m:NNNN/g' > existential_type_classes.out

field_names.out: field_names field_names.inp
	$(MDB) ./field_names < field_names.inp > field_names.out 2>&1

higher_order.out: higher_order higher_order.inp
	$(MDB) ./higher_order < higher_order.inp > higher_order.out 2>&1

implied_instance.out: implied_instance implied_instance.inp
	$(MDB) ./implied_instance < implied_instance.inp \
		> implied_instance.out 2>&1

interpreter.out: interpreter interpreter.inp
	$(MDB) ./interpreter interpreter.m < interpreter.inp \
		> interpreter.out 2>&1

lval_desc_array.out: lval_desc_array lval_desc_array.inp
	$(MDB) ./lval_desc_array < lval_desc_array.inp \
		> lval_desc_array.out 2>&1

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
multi_parameter.out: multi_parameter multi_parameter.inp
	$(MDB) ./multi_parameter < multi_parameter.inp 2>&1 | \
		sed 's/char.m:[0-9]*/char.m:NNNN/g' > multi_parameter.out

# We need to pipe the output through sed to avoid hard-coding dependencies on
# particular line numbers in the standard library source code.
output_term_dep.out: output_term_dep output_term_dep.inp
	$(MDB) ./output_term_dep < output_term_dep.inp 2>&1 | \
		sed 's/io.m:[0-9]*/io.m:NNNN/g' > output_term_dep.out 2>&1

print_goal.out: print_goal print_goal.inp
	$(MDB) ./print_goal < print_goal.inp > print_goal.out 2>&1

queens.out: queens queens.inp
	$(MDB) ./queens < queens.inp > queens.out 2>&1

queens_rep.out: queens_rep queens_rep.inp
	$(MDB) ./queens_rep < queens_rep.inp > queens_rep.out 2>&1

# We insert the names of entry labels into the label table only in a few grades
# (e.g. profiling grades). The debugger's redo label is an entry label. To
# avoid spurious inconsistencies in the output, we filter out its name even
# when known.
nondet_stack.out: nondet_stack nondet_stack.inp
	$(MDB) ./nondet_stack < nondet_stack.inp 2>&1 | \
		sed 's/nondet_stack.m:[0-9]*/nondet_stack.m:NNNN/g' | \
		sed 's/entry label MR_do_trace_redo_fail_deep/label UNKNOWN/g' \
		> nondet_stack.out 2>&1

resume_typeinfos.out: resume_typeinfos resume_typeinfos.inp
	$(MDB) ./resume_typeinfos < resume_typeinfos.inp 2>&1 | \
		sed 's/resume_typeinfos.m:[0-9]*/resume_typeinfos.m:NNNN/g' \
		> resume_typeinfos.out 2>&1

retry.out: retry retry.inp
	$(MDB) ./retry < retry.inp > retry.out 2>&1

shallow.out: shallow shallow.inp
	$(MDB) ./shallow < shallow.inp > shallow.out 2>&1

tabled_read.out: tabled_read tabled_read.inp tabled_read.data
	$(MDB) ./tabled_read < tabled_read.inp > tabled_read.out 2>&1

tabled_read_decl.out: tabled_read_decl tabled_read_decl.inp tabled_read_decl.data
	$(MDB) ./tabled_read_decl < tabled_read_decl.inp \
		> tabled_read_decl.out 2>&1

type_desc_test.out: type_desc_test type_desc_test.inp
	$(MDB) ./type_desc_test < type_desc_test.inp \
		> type_desc_test.out 2>&1

# Note that interactive.out.orig depends on $(interactive.ints) because
# interactive.inp contains interactive queries that require interactive.ints
# to have been built.
# When WORKSPACE is set, use $(WORKSPACE)/tools/lmc to compile the query.
ifneq ($(origin WORKSPACE), undefined)
export WORKSPACE
endif

interactive.out.orig: interactive $(interactive.ints)
ifneq ($(origin WORKSPACE),undefined)
	rm -rf lmc
	mkdir ./lmc
	cp $(WORKSPACE)/tools/lmc lmc/mmc
endif
	echo "echo on" > interactive.inp.tmp
	echo mmc_options $(ALL_GRADEFLAGS) $(ALL_MCFLAGS) \
			--trace minimum >> interactive.inp.tmp
	cat interactive.inp >> interactive.inp.tmp
	PATH="`pwd`/lmc:$$PATH" $(MDB) ./interactive \
		< interactive.inp.tmp > interactive.out.orig 2>&1
	rm -f interactive.inp.tmp
	rm -rf lmc

# We pipe the output through sed to avoid differences for `--use-subdirs',
# and to remove some spurious warnings that `gcc' and `ld' issue.
# XXX we should fix the spurious warnings about unresolved symbols.
# (The spurious warnings about exception handling are due to a flaw
# in the Digital Unix 3.2 linker, so that one is DEC's problem.)
interactive.out: interactive.out.orig
	cat interactive.out.orig | \
		sed \
		    -e '/mdb> mmc_options/d' \
		    -e '/In file included from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_trace_base.h:[0-9]*,$$/N' \
		    -e 's/In file included from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_trace_base.h:[0-9]*,.//' \
		    -e '/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_wrapper.h:[0-9]*,$$/N' \
		    -e 's/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_wrapper.h:[0-9]*,.//' \
		    -e '/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_imp.h:[0-9]*,$$/N' \
		    -e 's/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_imp.h:[0-9]*,.//' \
		    -e '/                 from mdb_query.c:[0-9]*:$$/N' \
		    -e 's/                 from mdb_query.c:[0-9]*:.//' \
		    -e '/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/unistd.h:[0-9]*: warning: .cuserid. redefined$$/N' \
		    -e 's/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/unistd.h:[0-9]*: warning: .cuserid. redefined.//' \
		    -e '/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/stdio.h:[0-9]*: warning: this is the location of the previous definition$$/N' \
		    -e 's/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/stdio.h:[0-9]*: warning: this is the location of the previous definition.//' \
		    -e '/In file included from \/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/stdarg.h:[0-9]*,$$/N' \
		    -e 's/In file included from \/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/stdarg.h:[0-9]*,.//' \
		    -e '/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_library_types.h:[0-9]*,$$/N' \
		    -e 's/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_library_types.h:[0-9]*,.//' \
		    -e '/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_imp.h:[0-9]*,$$/N' \
		    -e 's/                 from \/home\/mercury\/public\/.a\/lib\/mercury\/inc\/mercury_imp.h:[0-9]*,.//' \
		    -e '/                 from mdb_query.c:[0-9]*:$$/N' \
		    -e 's/                 from mdb_query.c:[0-9]*:.//' \
		    -e '/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/va-alpha.h:[0-9]*: warning: redefinition of .va_list.$$/N' \
		    -e 's/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/va-alpha.h:[0-9]*: warning: redefinition of .va_list..//' \
		    -e '/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/va_list.h:[0-9]*: warning: .va_list. previously declared here$$/N' \
		    -e 's/\/usr\/local\/apps\/gcc-2.95.3\/lib\/gcc-lib\/alpha-dec-osf5.1\/2.95.3\/include\/va_list.h:[0-9]*: warning: .va_list. previously declared here.//' \
		    -e '/\/usr\/bin\/ld:$$/N' \
		    -e 's/\/usr\/bin\/ld:.//' \
		    -e '/\/bin\/ld:$$/N' \
		    -e 's/\/bin\/ld:.//' \
		    -e '/Warning: Linking some objects which contain exception information sections$$/N' \
		    -e 's/Warning: Linking some objects which contain exception information sections.//' \
		    -e '/	and some which do not. This may cause fatal runtime exception handling$$/N' \
		    -e 's/	and some which do not. This may cause fatal runtime exception handling.//' \
		    -e '/	problems (last obj encountered without exceptions was .*)\.$$/N' \
		    -e 's/	problems (last obj encountered without exceptions was .*)\..//' \
		    -e '/Warning: Unresolved:$$/N' \
		    -e 's/Warning: Unresolved:.//' \
		    -e '/<predicate .main.\/2 mode 0>$$/N' \
		    -e 's/<predicate .main.\/2 mode 0>.//' \
		    -e '/<predicate .interactive:qperm.\/2 mode 0>$$/N' \
		    -e 's/<predicate .interactive:qperm.\/2 mode 0>.//' \
		    -e '/__start$$/N' \
		    -e 's/__start.//' \
		    > interactive.out
	# ignore egcs internal errors -- those are not our fault
	if grep 'gcc.*Internal compiler error' interactive.out; then \
		cp interactive.exp interactive.out; \
	fi

# We ignore the result of this action because
# the exit status of grep is not useful in this case
mdb_command_test.out: mdb_command_test mdb_command_test.inp
	-$(MDB) ./mdb_command_test < mdb_command_test.inp 2>&1 \
		| egrep "internal error in the trace help system" \
		> mdb_command_test.out

#-----------------------------------------------------------------------------#

DEPS=		$(PROGS:%=$(deps_subdir)%.dep)
DEPENDS=	$(PROGS:%=%.depend)
OUTS=		$(PROGS:%=%.out)
RESS=		$(PROGS:%=%.res)

dep_local:	$(DEPS)
depend_local:	$(DEPENDS)
check_local:	$(OUTS) $(RESS)
all_local:	$(PROGS)

realclean_local:
	rm -f Mercury.options.interactive

#-----------------------------------------------------------------------------#

SUBDIRS = declarative

check_subdirs:
	+for dir in $(SUBDIRS); do \
		(cd $$dir && $(SUBDIR_MMAKE) check) || exit 1; \
	done

dep_subdirs:
	+for dir in $(SUBDIRS); do \
		(cd $$dir && $(SUBDIR_MMAKE) dep) || exit 1; \
	done

depend_subdirs:
	+for dir in $(SUBDIRS); do \
		(cd $$dir && $(SUBDIR_MMAKE) depend) || exit 1; \
	done

realclean_subdirs:
	+for dir in $(SUBDIRS); do \
		(cd $$dir && $(SUBDIR_MMAKE) realclean) || exit 1; \
	done

clean_subdirs:
	+for dir in $(SUBDIRS); do \
		(cd $$dir && $(SUBDIR_MMAKE) clean) || exit 1; \
	done

all_subdirs:
	+for dir in $(SUBDIRS); do \
		(cd $$dir && $(SUBDIR_MMAKE) all) || exit 1; \
	done

#-----------------------------------------------------------------------------#


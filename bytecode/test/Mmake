#-----------------------------------------------------------------------------#
# Copyright (C) 1995-1998 The University of Melbourne. 
# This file may only be copied under the terms of the GNU General
# Public Licence - see the file COPYING in the Mercury distribution.
#-----------------------------------------------------------------------------#

PROGS=test00 test02 test03 test04 test05 test06 test07 test10 test15 test20\
	test22 test25 test30 test35 test40 test45
DEPENDS=$(PROGS:%=%.depend)
MBCFILES=$(PROGS:%=%.mbc)
MDISFILES=$(PROGS:%=%.mdis)
MDIS=LD_LIBRARY_PATH=$$LD_LIBRARY_PATH:.. ../mdis

# XXX: This is a hack to get dependencies to work. What we really want is:
# 	%.mdis: %.mbc
%.mdis: %.c
	$(MDIS) $*.mbc > $@

MAIN_TARGET=all
#GRADE
#GRADE=asm_fast.gc.prof
#MCFLAGS=-O6
# MCFLAGS=-O6 --intermodule-optimization
# MLFLAGS=--no-strip -g -static
#MLFLAGS=-static
MCFLAGS=-O-1 --no-dead-proc-elim

#GRADE=reg.gc
#GRADE=asm_fast.gc.prof
#	XXX: the debug grade currently doesn't work since there are
#	unresolved references.
#	Either the debug code should be nuked, or it should be
#	built regularly and regression tested. *Grr..*
#GRADE=debug.gc

MGNUCFLAGS=-O0 -g
MCFLAGS=--debug --generate-bytecode --no-inlining --no-follow-code \
	--no-smart-indexing --no-middle-rec --no-llds-optimize
MLFLAGS=--no-strip -v
RM_C=:

.PHONY: all
all : $(PROGS) $(MDISFILES)

# XXX: This is only a very simplistic test. Add more to test
# the behaviour of bytecode interpretation.
test : all
	status=ok ; \
	for file in $(MDISFILES) ; \
	do \
		if diff -w $$file `basename $$file .mdis`.bytedebug \
			> /dev/null 2>&1 ; \
		then \
			true ; \
		else \
			echo "*** Error: test failed on $$file" ; \
			status=failed ; \
		fi ; \
	done ; \
	if test $$status = ok ; \
	then \
		echo "All tests succeeded" ; \
	fi

.PHONY: depend
depend: $(DEPENDS)

.PHONY: strip
strip: $(PROGS)
	strip $(PROGS)

wayclean: realclean
	-rm *bytedebug *mbc *mdis *_stub.c *.o
